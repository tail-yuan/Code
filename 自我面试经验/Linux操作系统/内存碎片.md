### 内存碎片

是指无法被利用的内存,分为外部内存碎片和内部内存碎片.

为了避免多进程同时对同一个物理内存写入的安全问题,引入了虚拟内存,也就是进程地址空间.每个进程都自认为独占4GB的内存空间.采用分段分页的机制映射虚拟内存和物理内存.正是这种机制导致了内存碎片的问题.

#### 外部碎片

是指内存中**还没有被分配出去的内存空间**,由于太小了**无法分配给申请内存空间的新进程**的内存区域.

是由于分段机制导致的: 根据程序需要将物理内存分成一段一段的进行管理.通过段表进行映射.

有多少需求就会分配多大的内存的段,但是由于每个段的长度不固定,多个段未必能够恰好使用一个连续的物理空间.所以会产生多个不连续的小的物理内存,导致新的程序无法加载进内存,就是外部碎片.

![分段式映射表](https://image-1309381344.cos.ap-nanjing.myqcloud.com/img/image-20230919121916933.png)

![外部碎片](https://image-1309381344.cos.ap-nanjing.myqcloud.com/img/image-20230919122151874.png)

![外部碎片](https://image-1309381344.cos.ap-nanjing.myqcloud.com/img/image-20230919122305017.png)

#### 内部碎片

是指已经被分配给某一进程了的内存空间.但是由于采用分页机制,每一页的大小是固定的4KB大小空间.就可能会存在剩余用不完的情况,就是内部碎片.

![分页式结构](https://image-1309381344.cos.ap-nanjing.myqcloud.com/img/image-20230919122451526.png)

页与页之间是紧密排列的所以不会出现像分段式结构中的外部碎片的情况,在段与段之间出现间隔空间.

#### 解决内存碎片问题

### 伙伴系统

在Linux操作系统下，"伙伴系统" 通常指的是伙伴分配算法（Buddy System Allocation），它是一种用于管理操作系统内存的技术。这个系统有助于操作系统**高效地分配和释放内存块**，以满足进程的内存需求。下面是有关Linux中伙伴系统的一些关键信息：

1. **内存管理：** 伙伴系统是Linux内核的一部分，用于管理物理内存和虚拟内存。它负责跟踪内存块的使用情况，以便为进程分配内存或释放不再使用的内存。

2. **内存分配：** 伙伴系统采用了一种分治的策略，将物理内存划分为多个固定大小的块（通常是2的幂次方大小的块）。当进程需要分配内存时，**伙伴系统会查找一个大小合适的内存块来满足请求**。如果找到了一个大于请求的块，它会将该块分割成两个较小的块，并将其中一个分配给进程。

3. **内存释放：** 当进程释放内存时，伙伴系统会将**该内存块与其邻近的同样大小的块合并**，以便形成更大的块。这个过程持续进行，直到无法再合并块为止。

4. **碎片问题：** 伙伴系统有助于**减少内存碎片**，因为它倾向于**分配大小合适的内存块**，而且在**释放内存时合并块**。这有助于避免外部碎片（无法合并的空闲内存）和内部碎片（内存块中未使用的部分）。

总之，Linux下的伙伴系统是一种用于高效管理内存的技术，它通过分配和释放内存块的方式来满足进程的内存需求，并尽力减少内存碎片问题。这有助于操作系统在多个进程之间有效地共享和管理内存资源。

![伙伴机制](https://image-1309381344.cos.ap-nanjing.myqcloud.com/img/image-20230919122641822.png)

#### 解决内部碎片-slab算法

将内存页分为更小的单位处理,对小空间对象进行分配,不需要分配整个页面给对象.

但是小对象如果频繁申请,就会造成内存频繁的分配和回收,那么slab算法引入缓存的机制处理.