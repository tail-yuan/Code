### 一致性哈希

主要是针对有状态的服务器,缩小集群节点,扩充节点时涉及到的数据迁移损耗.

- 无状态服务: 无需负责存储状态数据,仅仅需要内聚业务执行逻辑的服务.
- 有状态服务: 需要维护好状态数据与所从属服务器节点之间的映射关系.

当集群中节点一旦发生扩容缩容,节点数量发生变更时,对应的映射关系发生变化,数据要从一个节点迁移到另一个节点,这个过程十分笨重.

一致性哈希（Consistent Hashing）**是一种用于在分布式系统中进行数据分片和负载均衡的技术**。它主要用于解决当节点数量发生变化时，**分布式系统中数据分片的重新分配问题**，以及**节点故障时数据的迁移问题**。一致性哈希算法的目标是在系统的扩展性和可靠性之间找到一个平衡。

在传统的哈希算法中，当节点数发生变化时（添加或删除节点），所有数据的哈希映射都可能会改变，导致大规模的数据迁移，对系统性能和稳定性造成影响。

一致性哈希通过引入**虚拟节点**和环状哈希环的概念，使得每个节点分布在环上，并将数据映射到环上的位置。这种方式使得节点的增减对整个哈希环上的数据分布影响较小。

![image-20230926205729350](https://image-1309381344.cos.ap-nanjing.myqcloud.com/img/image-20230926205729350.png)

一致性哈希的工作原理如下：

1. **构建哈希环：** 将所有的节点通过哈希函数映射到一个环上，形成哈希环。环上的位置由哈希值决定。

2. **数据映射：** 对于需要存储的数据，使用同样的哈希函数计算哈希值，并将数据映射到离它最近的下一个节点（沿顺时针方向）上。这个节点即为数据的所属节点。

3. **节点变化处理：** 当节点数量发生变化时，只影响新加入节点和其后的节点，不需要改变其他节点的映射。数据只会从变化的节点和其后的节点中迁移。

4. **节点故障处理：** 当节点故障时，数据只需要从故障节点后的下一个节点开始，按顺时针方向查找新的存储节点。

引入虚拟节点之后,可以根据服务器具体的硬件配置虚拟出不同数量的虚拟节点放到环上,硬件好的服务器可以映射更多的虚拟节点,抢占更多的服务链接.

![image-20230926205629390](https://image-1309381344.cos.ap-nanjing.myqcloud.com/img/image-20230926205629390.png)
